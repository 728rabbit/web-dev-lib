class iCalendar{constructor(e={}){this.selfObj=null,this.elementID=e.elementID||"icalendar",this.lang=e.lang||"en",this.displayMode=e.displayMode||"day",this.displayDate=new Date(e.date||new Date).toLocaleString("en-US",{timeZone:"Asia/Hong_Kong"}),this.startHm=e.startHm||800,this.endHm=e.endHm||2200,this.interval=e.interval||5,this.maxHeight=e.maxHeight||"none",this.resources=null,this.events=null,this.resourcesURL=e.resources||!1,this.noResources=!1,this.eventsURL=e.events||!1,this.eventTemplate=e.eventTemplate||!1,this.eventClick=e.eventClick||!1,this.extraParas=e.extraParas||!1}init(e=null,t=null){if(this.selfObj=document.getElementById(this.elementID),this.selfObj)return this.selfObj.style.position="relative",this.selfObj.style.background="#fff",this.selfObj.style.fontFamily="Arial, sans-serif",this.selfObj.style.fontSize="13px",this.selfObj.style.border="1px solid #e6e6e6",this.selfObj.style.boxSizing="border-box",this.selfObj.style.overflow="hidden",["div.fixedCorner","div.fixedHeader","div.fixedLeft","div.timeSlots"].forEach(e=>{this.selfObj.querySelectorAll(e).forEach(e=>e.remove())}),this.showLoadingMask(),this.resources=e||this.resources,this.events=t||this.events,this.setupElements(),null===e&&this.resourcesURL?this.fetchData(this.resourcesURL,e=>{this.resources=e,this.eventsURL&&this.fetchData(this.eventsURL,e=>{this.events=e,this.refresh()})}):null===t&&this.eventsURL&&this.fetchData(this.eventsURL,e=>{this.events=e,this.refresh()}),this}refresh(e,t){document.getElementById("icalendar-showdate").innerHTML=this.getDisplayDate(),this.resources=e||this.resources,this.events=t||this.events,this.showLoadingMask(),null===this.resources&&this.resourcesURL?this.fetchData(this.resourcesURL,e=>{this.resources=e,this.eventsURL&&this.fetchData(this.eventsURL,e=>{this.events=e,this.setupElements(!0)})}):this.eventsURL?this.fetchData(this.eventsURL,e=>{this.events=e,this.setupElements(!0)}):this.setupElements(!0)}setupElements(e=!1){e||(this.renderControls(),this.renderBody(),this.syncScroll()),this.setHeader(),this.setLeft(),this.setSlots(),this.drawEvents(this.events),setTimeout(this.hideLoadingMask,500)}renderControls(){var e=this.createElement("table",{width:"100%"}),t=this.createElement("tr"),i=this.createControlsLeftCell(),s=this.createControlsCenterCell(),a=this.createControlsRightCell(),i=(t.append(i,s,a),e.appendChild(t),this.createElement("div",{position:"relative",padding:"8px 4px",border:"1px solid #e6e6e6",boxSizing:"border-box"}));i.appendChild(e),this.selfObj.appendChild(i)}createControlsLeftCell(){var e=this.createElement("td",{width:"30%",textAlign:"left"}),t=this.createControlButton("zh"===this.lang?"跳至":"Go To",()=>this.showTodayDialog()),i=this.createControlButton("zh"===this.lang?"前一個":"Prev",()=>this.changeDate(-1)),s=this.createControlButton("zh"===this.lang?"後一個":"Next",()=>this.changeDate(1));return e.append(t,i,s),e}createControlsCenterCell(){var e=this.createElement("td",{fontSize:"16px",textAlign:"center"});return e.innerHTML=`<strong id="icalendar-showdate">${this.getDisplayDate()}</strong>`,e}createControlsRightCell(){const i=this.createElement("td",{width:"30%",textAlign:"right"});return[{text:"zh"===this.lang?"月":"Month",mode:"month"},{text:"zh"===this.lang?"週":"Week",mode:"week"},{text:"zh"===this.lang?"日":"Day",mode:"day"}].forEach(({text:e,mode:t})=>{e=this.createControlButton(e,()=>this.changeMode(t));i.appendChild(e)}),i}createControlButton(e,t){var i=this.createElement("button",{type:"button",display:"inline-block",background:"#f6f6f6",fontSize:"14px",height:"28px",padding:"4px 8px",marginLeft:"4px",marginRight:"4px",border:"2px solid #e6e6e6",boxSizing:"border-box",borderRadius:"4px",verticalAlign:"middle",cursor:"pointer"});return i.textContent=e,i.onclick=t,i}showTodayDialog(){var e,t=this.selfObj.querySelector("div.todaydialog");t?t.remove():(t=this.createElement("div",{position:"absolute",background:"#fff",top:"40px",left:"8px",padding:"8px",border:"2px solid #e6e6e6",boxSizing:"border-box",borderRadius:"4px",overflow:"hidden",zIndex:"5"},"todaydialog"),(e=this.createElement("input",{border:"1px solid #e6e6e6",width:"140px",height:"28px",padding:"2px 8px",boxSizing:"border-box"})).type="date",e.placeholder="YYYY-MM-DD",e.addEventListener("change",e=>{var t;/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/.test(e.target.value)&&(t=new Date(e.target.value),this.displayDate=t.toLocaleString("en-US",{timeZone:"Asia/Hong_Kong"}),this.refresh(),e.target.closest("div.todaydialog").remove())}),t.appendChild(e),this.selfObj.appendChild(t))}changeDate(e){let t=new Date(this.displayDate);"week"===this.displayMode?t.setDate(t.getDate()+7*e):"day"===this.displayMode?t.setDate(t.getDate()+e):t=this.getPrevNextMonth(this.displayDate,e),this.displayDate=t.toLocaleString("en-US",{timeZone:"Asia/Hong_Kong"}),this.refresh()}changeMode(e){this.displayMode=e,this.refresh()}getDisplayDate(){var e;return"week"===this.displayMode?((e=new Date(this.displayDate)).setDate(e.getDate()+6),"zh"===this.lang?`由 ${this.getYmd(this.displayDate)} 至 `+this.getYmd(e):`From ${this.getYmd(this.displayDate)} To `+this.getYmd(e)):this.getYmd(this.displayDate,"month"===this.displayMode?this.displayMode:"week")}renderBody(){var e=this.createElement("div",{position:"relative",background:"#f6f6f6",boxSizing:"border-box",overflow:"hidden"},"details");this.fixedCorner=this.createElement("div",{position:"absolute",background:"#f6f6f6",top:"0px",left:"0px",width:"61px",height:"47px",border:"1px solid #e6e6e6",boxSizing:"border-box",zIndex:"5"},"fixedCorner"),this.fixedHeader=this.createElement("div",{position:"absolute",top:"0px",left:"61px",right:"0px",overflowX:"hidden",overflowY:"scroll",zIndex:"4"},"fixedHeader"),this.fixedLeft=this.createElement("div",{position:"absolute",top:"46px",left:"0px",maxHeight:this.maxHeight+"px",zIndex:"3"},"fixedLeft"),this.timeSlots=this.createElement("div",{position:"relative",background:"#fff",maxHeight:this.maxHeight+"px",marginTop:"46px",marginLeft:"61px",overflowX:"auto",overflowY:"scroll"},"timeSlots"),e.append(this.fixedCorner,this.fixedHeader,this.fixedLeft,this.timeSlots),this.selfObj.appendChild(e)}createElement(e,t={},i){e=document.createElement(e);return i&&(e.className=i),Object.assign(e.style,t),e}setHeader(){if(this.noResources=!1,(!this.resources||this.resources&&0===this.resources.length)&&(this.resources=[{id:0,name:""}],this.noResources=!0),this.fixedCorner.style.display="week"===this.displayMode||"day"===this.displayMode?"block":"none",this.fixedHeader.style.left="week"===this.displayMode||"day"===this.displayMode?"61px":"0px",this.fixedHeader.style.overflow="week"===this.displayMode||"day"===this.displayMode?"hidden scroll":"hidden",this.fixedHeader.innerHTML="","week"===this.displayMode||"day"===this.displayMode){var e=this.createElement("table",{width:"100%",borderCollapse:"collapse"});const n=this.createElement("tr");this.resources&&this.resources.forEach((t,e)=>{if("week"===this.displayMode){var i=new Date(this.displayDate);for(let e=0;e<7;e++){var s=new Date(i),a=(s.setDate(i.getDate()+e),this.createElement("th",{position:"relative",background:"#f6f6f6",width:`calc((100% - 60px) / ${7*this.resources.length})`,minWidth:"180px",height:"46px",padding:"4px",textAlign:"center",border:"1px solid #e6e6e6",boxSizing:"border-box"}));a.innerHTML=t.id?t.name+"<br/><small>"+this.getYmd(s,"week")+"</small>":""+this.getYmd(s,"week"),n.appendChild(a)}}else{var r;"day"===this.displayMode&&((r=this.createElement("th",{position:"relative",background:"#f6f6f6",width:`calc((100% - 60px) / ${this.resources.length})`,minWidth:"180px",height:"46px",padding:"4px",textAlign:"center",border:"1px solid #e6e6e6",boxSizing:"border-box"})).innerHTML=t.id?""+t.name:"zh"===this.lang?"今天":"Today",n.appendChild(r))}}),e.appendChild(n),this.fixedHeader.appendChild(e)}else if("month"===this.displayMode){e=this.createElement("table",{width:"100%",borderCollapse:"collapse"});const i=this.createElement("tr"),s="zh"===this.lang?["日","一","二","三","四","五","六"]:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];s.forEach(e=>{var t=this.createElement("th",{position:"relative",background:"#f6f6f6",width:`calc((100% / ${s.length})`,height:"46px",padding:"4px",textAlign:"center",border:"1px solid #e6e6e6",boxSizing:"border-box"});t.textContent=e,i.appendChild(t)}),e.appendChild(i),this.fixedHeader.appendChild(e)}e=this.selfObj.querySelector(".fixedHeader").offsetHeight;this.fixedCorner.style.height=e+"px",this.fixedLeft.style.top=e+"px",this.timeSlots.style.marginTop=e+"px"}setLeft(){this.fixedLeft.style.display="week"===this.displayMode||"day"===this.displayMode?"block":"none",this.fixedLeft.innerHTML="";var e=this.createElement("table",{width:"100%",borderCollapse:"collapse"});let t=this.startHm;for(;t<=this.endHm;){var i=this.createElement("tr"),s=this.createElement("th",{position:"relative",background:"#f6f6f6",width:"60px",height:"30px",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box",textAlign:"center"}),a=t.toString().padStart(4,"0"),a=a.slice(0,2)+":"+a.slice(2);s.innerHTML=a,i.appendChild(s),e.appendChild(i),t=this.getNextTimeSlot(t,this.interval)}this.fixedLeft.appendChild(e)}setSlots(){if(this.timeSlots.style.marginLeft="week"===this.displayMode||"day"===this.displayMode?"61px":"0px",this.timeSlots.style.maxHeight="week"===this.displayMode||"day"===this.displayMode?this.maxHeight+"px":"none",this.timeSlots.style.overflow="week"===this.displayMode||"day"===this.displayMode?"auto scroll":"hidden",this.timeSlots.innerHTML="","week"===this.displayMode||"day"===this.displayMode){if(this.resources){var e=this.createElement("table",{width:"100%",borderCollapse:"collapse"});let n=this.startHm;for(;n<=this.endHm;){const c=this.createElement("tr");this.resources.forEach((t,e)=>{var i=new Date(this.displayDate);if("week"===this.displayMode)for(let e=0;e<7;e++){var s=new Date(i),a=(s.setDate(i.getDate()+e),this.createElement("td",{position:"relative",background:"#fff",width:`calc((100% - 60px) / ${7*this.resources.length})`,minWidth:"180px",height:"30px",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box"}));a.setAttribute("data-timeslot",t.id+"_"+this.getYmd(s)+"_"+n),c.appendChild(a)}else{var r=this.createElement("td",{position:"relative",background:"#fff",width:`calc((100% - 60px) / ${this.resources.length})`,minWidth:"180px",height:"30px",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box"});r.setAttribute("data-timeslot",t.id+"_"+this.getYmd(i)+"_"+n),c.appendChild(r)}}),e.appendChild(c),n=this.getNextTimeSlot(n,this.interval)}this.timeSlots.appendChild(e)}}else{var i=new Date(this.displayDate),s=i.getFullYear(),a=i.getMonth(),i=new Date(s,a,1),r=new Date(s,a+1,0),n=i.getDay(),d=r.getDate(),o=this.createElement("table",{width:"100%",borderCollapse:"collapse"});let t=this.createElement("tr");for(let e=0;e<n;e++){var l=this.createElement("td",{position:"relative",width:"calc(100% / 7)",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box",verticalAlign:"top",overflow:"hidden"});t.appendChild(l)}for(let e=1;e<=d;e++){var h=this.createElement("td",{position:"relative",width:"calc(100% / 7)",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box",verticalAlign:"top",overflow:"hidden"});h.setAttribute("data-timeslot",this.getYmd(s+"-"+(a+1)+"-"+e)),h.innerHTML=this.createSvgSquare(e),t.appendChild(h),(e+n)%7==0&&(o.appendChild(t),t=this.createElement("tr"))}if(0<t.querySelectorAll("td").length&&t.querySelectorAll("td").length<7)for(let e=t.querySelectorAll("td").length;e<7;e++){var p=this.createElement("td",{position:"relative",width:"calc(100% / 7)",padding:"4px",border:"1px solid #e6e6e6",boxSizing:"border-box",verticalAlign:"top",overflow:"hidden"});t.appendChild(p)}o.appendChild(t),this.timeSlots.appendChild(o)}}createSvgSquare(e){return`<svg viewBox="0 0 40 40" preserveAspectRatio="xMidYMid meet" style="position: relative; width: 100%; height: 100%; display: block; cursor: pointer;"><rect x="0" y="0" width="40" height="40" style="fill: #fff;"></rect><text x="32" y="8" alignment-baseline="middle" text-anchor="middle" style="fill: #e6e6e6; font-size: 10px;">${e}</text></svg>`}syncScroll(){this.timeSlots.onscroll=()=>{this.fixedHeader.querySelector("table").style.transform=`translateX(${-this.timeSlots.scrollLeft}px)`,this.fixedLeft.querySelector("table").style.transform=`translateY(${-this.timeSlots.scrollTop}px)`}}drawEvents(e){this.events=e||this.events,this.timeSlots.querySelectorAll("div.ievent").forEach(e=>e.remove());const d=e=>{e=e.toString().padStart(4,"0");return e.slice(0,-2)+":"+e.slice(-2)};e&&(e.sort((e,t)=>e.targetDate===t.targetDate?e.startHm-t.startHm:new Date(e.targetDate)-new Date(t.targetDate)),e.forEach(t=>{if("week"===this.displayMode||"day"===this.displayMode){var e=this.timeSlots.querySelector(`[data-timeslot="${this.noResources?0:t.resourceId}_${t.targetDate}_${Math.max(this.startHm,t.startHm)}"]`);if(e){var i=e.querySelectorAll("div.ievent").length,s=60*Math.floor(Math.max(this.startHm,t.startHm)/100)+Math.max(this.startHm,t.startHm)%100,a=60*Math.floor(Math.min(this.endHm,t.endHm)/100)+Math.min(this.endHm,t.endHm)%100,a=30*(Math.ceil((a-s)/this.interval)+1);const r=this.createElement("div",{position:"absolute",background:t.background||"#3788d8",top:"0px",left:40*i+"px",right:"0px",height:a+"px",padding:"8px",border:"1px solid #e6e6e6",boxSizing:"border-box",borderRadius:"8px",wordBreak:"break-all",overflow:"hidden",cursor:"pointer",opacity:"0.95",zIndex:1},"ievent "+this.displayMode);r.innerHTML="function"==typeof this.eventTemplate?this.eventTemplate(t):`<div>${t.content||d(t.startHm)+" ~ "+d(t.endHm)}</div>`,r.setAttribute("data-id",t.id||0),r.setAttribute("data-targetDate",t.targetDate||""),r.setAttribute("data-startHm",t.startHm||""),r.setAttribute("data-endHm",t.endHm||""),r.onclick=e=>{e.stopPropagation();e=r.style.zIndex;this.timeSlots.querySelectorAll("div.ievent").forEach(e=>e.style.zIndex=1),"1"===e&&(r.style.zIndex=2),"function"==typeof this.eventClick&&this.eventClick(t)},e.appendChild(r)}}else{s=this.timeSlots.querySelector(`[data-timeslot="${t.targetDate}"]`);if(s){i=s.querySelectorAll("div.ievent").length;const n=this.createElement("div",{position:"relative",background:t.background||"#3788d8",width:"100%",minHeight:"25px",padding:"4px 8px",marginTop:0===i?"-64%":"0px",border:"1px solid #e6e6e6",boxSizing:"border-box",borderRadius:"4px",wordBreak:"break-all",overflow:"hidden",cursor:"pointer",opacity:"0.95",zIndex:1},"ievent "+this.displayMode);n.innerHTML="function"==typeof this.eventShortTemplate?this.eventShortTemplate(t):`<div>${t.short_content||d(t.startHm)+" ~ "+d(t.endHm)}</div>`,n.setAttribute("data-id",t.id||0),n.setAttribute("data-targetDate",t.targetDate||""),n.setAttribute("data-startHm",t.startHm||""),n.setAttribute("data-endHm",t.endHm||""),n.onclick=e=>{e.stopPropagation();e=n.style.zIndex;this.timeSlots.querySelectorAll("div.ievent").forEach(e=>e.style.zIndex=1),"1"===e&&(n.style.zIndex=2),"function"==typeof this.eventClick&&this.eventClick(t)},s.appendChild(n)}}}))}getPrevNextMonth(e,t){e=new Date(e);return e.setMonth(e.getMonth()+t),e.toISOString().split("T")[0]}getMonthStartEnd(e){var e=new Date(e),t=new Date(e.getFullYear(),e.getMonth(),1),e=new Date(e.getFullYear(),e.getMonth()+1,0),i=e=>{return e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")};return{start:i(t),end:i(e)}}getYmd(e,t){var e=new Date(e),e=new Intl.DateTimeFormat("zh"===this.lang?"zh-HK":"en-US",{timeZone:"Asia/Hong_Kong",year:"numeric",month:"2-digit",day:"2-digit",weekday:"short"}).formatToParts(e),i=e.find(e=>"year"===e.type).value,s=e.find(e=>"month"===e.type).value,a=e.find(e=>"day"===e.type).value,e=e.find(e=>"weekday"===e.type).value.replace("星期","").replace("週","");return"month"===t?"zh"===this.lang?s+"月/"+i:s+"/"+i:"week"===t?i+`-${s}-${a} (${e})`:i+`-${s}-`+a}getNextTimeSlot(e,t){let i=e+t;return i=60<=i%100?100*(Math.floor(i/100)+1)+(i%100-60):i}async fetchData(t,i){try{let e=t;var s,a,r,n;this.extraParas||(this.extraParas={}),"month"===this.displayMode?(s=this.getMonthStartEnd(this.displayDate),this.extraParas.startDate=s.start,this.extraParas.endDate=s.end):"week"===this.displayMode?((a=new Date(this.displayDate)).setDate(a.getDate()+6),this.extraParas.startDate=this.getYmd(this.displayDate),this.extraParas.endDate=this.getYmd(a)):(this.extraParas.startDate=this.getYmd(this.displayDate),this.extraParas.endDate=this.getYmd(this.displayDate)),this.extraParas&&(r=new URLSearchParams(this.extraParas).toString(),n=t.includes("?")?"&":"?",e=t+n+r);var d=await(await fetch(e)).json();"function"==typeof i&&i(d)}catch(e){return console.log("Error fetching data:",e),!1}}addSpinnerAnimationStyle(){var e=document.getElementById("icalendar-spin-animation");e||((e=this.createElement("style")).id="icalendar-spin-animation",e.innerHTML="@keyframes icalendar-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}",document.head.appendChild(e))}showLoadingMask(){this.addSpinnerAnimationStyle();const e=document.getElementById("icalendar-loading-mask");if(!e){const e=this.createElement("div",{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.7)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"10"});e.id="icalendar-loading-mask";var t=this.createElement("div",{border:"4px solid #f3f3f3",borderTop:"4px solid #3498db",borderRadius:"50%",width:"40px",height:"40px",animation:"icalendar-spin 1s linear infinite"});t.id="icalendar-spin",e.appendChild(t),this.selfObj.appendChild(e)}}hideLoadingMask(){var e=document.getElementById("icalendar-loading-mask");e&&e.remove()}}